# ADVANCED CDN TEMPLATE: {domain} -> wsrv.nl (Origin: {storage_domain})
server {
    listen 80;
    server_name {domain};
    location /.well-known/acme-challenge/ { root /var/www/certbot; }
    location / { return 301 https://$host$request_uri; }
}

server {
    listen 443 ssl http2;
    server_name {domain};

    ssl_certificate /etc/letsencrypt/live/{domain}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{domain}/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    location / {
        # 1. Logic for bots and internal requests
        set $is_internal "";
        if ($http_user_agent ~* (googlebot|yandex|bingbot|applebot|wsrv|imagefetcher)) {
            set $is_internal "yes";
        }
        if ($arg_internal) {
            set $is_internal "yes";
        }

        # Serve original if it's a bot or internal request
        if ($is_internal = "yes") {
            rewrite ^/(.*)$ /internal_source/$1 last;
        }

        # 2. Optimization for regular users via wsrv.nl
        # Pointing directly to storage_domain to avoid DNS loop/propagation issues
        set $original_url "https://{storage_domain}$uri";
        
        # Proxy to wsrv.nl with custom format and quality
        proxy_pass https://wsrv.nl/?url=$original_url&w=$arg_w&h=$arg_h&fit=$arg_fit&q=$out_quality&output=$out_format;

        proxy_set_header Host wsrv.nl;
        proxy_ssl_server_name on;

        # Caching optimization result
        proxy_cache cdn_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_key "$host$uri$is_args$args";
        
        # Security & Debug headers
        add_header X-Cache-Status $upstream_cache_status;
        add_header Access-Control-Allow-Origin '*';
        add_header X-Content-Type-Options nosniff;
        
        proxy_buffering on;
        proxy_buffers 16 16k;
        proxy_buffer_size 32k;
        
        expires 30d;
    }

    # 3. Endpoint for original files (proxied to MinIO)
    location /internal_source/ {
        internal;
        rewrite ^/internal_source/(.*)$ /$1 break;

        proxy_pass https://{storage_domain};
        proxy_set_header Host {storage_domain};
        
        # Cache original for 7 days
        proxy_cache cdn_cache;
        proxy_cache_valid 200 7d;
        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        
        add_header X-Internal-Source "Origin-MinIO";
    }
    
    access_log /var/log/nginx/{domain}_access.log main;
    error_log /var/log/nginx/{domain}_error.log warn;
}
