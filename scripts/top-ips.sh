#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤
# –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–ü-20 IP –∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LOG_FILE="$PROJECT_ROOT/logs/nginx/access.log"

if [ ! -f "$LOG_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: $LOG_FILE"
    exit 1
fi

echo "üìä –¢–û–ü-20 IP –∞–¥—Ä–µ—Å–æ–≤ (–≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤):"
echo "--------------------------------------"
cat "$LOG_FILE" | awk '{print $1}' | sort | uniq -c | sort -nr | head -n 20
echo "--------------------------------------"

echo ""
echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ (4xx/5xx):"
echo "--------------------------------------"
grep -E ' "(4|5)[0-9]{2}" ' "$LOG_FILE" | tail -n 10
